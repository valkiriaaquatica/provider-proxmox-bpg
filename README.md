# Proxmox BPG Provider

`provider-proxmox-bpg` is a [Crossplane](https://crossplane.io/) provider built using
[Upjet](https://github.com/crossplane/upjet). It exposes XRM-conformant managed
resources for the [Proxmox Virtual Environment](https://www.proxmox.com/) API.
## Getting Started

Install the provider by using the following command after changing the image tag
to the [latest release](https://marketplace.upbound.io/providers/upbound/provider-proxmox-bpg):
```
up ctp provider install provider-proxmox-bpg:v0.1.0
```

Alternatively, you can use declarative installation:
```
cat <<EOF | kubectl apply -f -
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-proxmoxbpg
spec:
  package: crossplane/provider-proxmoxbpg:v0.1.0
EOF
```

Notice that in this example Provider resource is referencing ControllerConfig with debug enabled.

You can see the API reference [here](https://doc.crds.dev/github.com/valkiriaaquatica/provider-proxmox-bpg)

## Developing

If you have devbox or want to work with it, it makes life easier for packages like go, do the following:
```console
cd devbox/
devbox install
devbox shell
```

Run code-generation pipeline:
```console
go run cmd/generator/main.go "$PWD"
```
Checkout sub-repositories:

```console
make submodules
```

Execute code generation:

```console
make generate
```


Run against a Kubernetes cluster:

Install the CRDs in the cluster:
```console
kubectl apply -f package/crds/
```

Run the image and keep this terminal to see the logs:
```console
make run
```

Build, push, and install:

```console
make all
```

Build binary:

```console
make build
```

## Report a Bug

For filing bugs, suggesting improvements, or requesting new features, please
open an [issue](https://github.com/valkiriaaquatica/provider-proxmox-bpg/issues).


## Reported Issues

As already mentioned [here](https://github.com/crossplane-contrib/provider-confluent/blob/main/README.md), one workaround for broken or incomplete documentation files is to prepend the expected front matter to the file manually.

You can use the following Bash script to patch the file:

```bash
broken_doc_file=".work/bpg/proxmox/docs/resources/resource_with_error.md"

echo '--- 
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "resource_with_error Resource - terraform-provider-proxmox"
subcategory: ""
description: |-
  This resource creates and manages a Proxmox description of the resource.
---' | cat - "$broken_doc_file" > temp && mv temp "$broken_doc_file"

## HOW TO TEST WITH ANOTHER TERRAFORM PROVIDER
  In case you need t test with your own forked terraform provider, some adjustes need to be take in charge.
  1. Fork the original terraform provider and make the changes u want. Follow the contriobution guide and check it exists on ls -l $(go env GOPATH)/bin/terraform-provider-proxmox
  2. After testing in local it works well

## KNOWN ISSUES
- On the resources proxmox_virtual_environment_network_linux_vlan+proxmox_virtual_environment_network_linux_bridge  sometimes there is an error that also happens with terraform whe, that is "Could not reload net work configuration on node 'pve', unexpected error" that will make even if the resource its well applied on terraform to be on Synced False and Ready False , that is like "False Negative" because it was well created on Proxmox

## TODO list:
  - apply correcctly a virtualenvironmentcertificate
  - proxmox_virtual_environment_cluster_options + proxmox_virtual_environment_hardware_mapping_dir + EnvironmentHardwareMappingPci + proxmox_virtual_environment_hardware_mapping_usb its pending because of error on schema.json asi ssaid in this issue https://github.com/crossplane/upjet/issues/372  when run make generate (this error reports cannot infer type from schema of field map: invalid schema type TypeInvalid)
  - CI publish artifactd and use image
  - virtualenvironmentcertificate,virtualenvironmentdatastores  its not getting get
  - test tge ones wit "file" to try the upload
  - add linting to examples
  - proxmox_virtual_environment_metrics_server  check on the tf provider (see https://github.com/bpg/terraform-provider-proxmox/blob/main/proxmox/cluster/metrics/server.go) error unmarshalling json with lists observe failed: cannot run refresh: refresh failed: Unable to Refresh Resou -- pending to test with terraform
│ rce: An unexpected error occurred while attempting to 
  - proxmox_virtual_environment_network_linux_bridge  + proxmox_virtual_environment_network_linux_vlan terror when applying "observe failed: cannot set critical annotations: cannot get external name: cannot find id in tfstate" try to change in the provider -- pending to test with terraform  -> ¿¿ check this?? -> using terraform show and test -> test ot bump the upjet to >1-5-0 that do not has the skp fix external name when != id , when not placing externalnem and leaving the repsonability to the tf provider, the problem is that the first tfstate it created it a state with te resourc ebut without the id so thats wrong.
  The tfstate that should be created after init and just refreshing terraform apply -refresh-only -auto-approve -input=false -lock=false -json  but it is creating th biiger one 
  {
  "version": 4,
  "terraform_version": "1.9.8",
  "serial": 1,
  "lineage": "855beeb4-2f45-b7d0-4682-09e670bf79ec",
  "outputs": {},
  "resources": [],
  "check_results": null
}


wrong one 
{
  "version": 4,
  "terraform_version": "1.9.8",
  "serial": 2,
  "lineage": "a88587ad-5e67-4acb-96b8-84f103dcc7be",
  "outputs": {},
  "resources": [
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_network_linux_bridge",
      "name": "vmbr11",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "address": null,
            "address6": null,
            "autostart": null,
            "comment": null,
            "gateway": null,
            "gateway6": null,
            "id": "",
            "mtu": null,
            "name": "vmbr11",
            "node_name": "pve",
            "ports": null,
            "vlan_aware": null
          },
          "sensitive_attributes": []
        }
      ]
    }
  ],
  "check_results": null
}
